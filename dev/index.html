<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="INFOTIV" /><link rel="canonical" href="https://infotiv-research.github.io/gokart-documentation/dev/" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>For Developers - Infotiv Autonomous Platform</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "For Developers";
        var mkdocs_page_input_path = "dev.md";
        var mkdocs_page_url = "/gokart-documentation/dev/";
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Infotiv Autonomous Platform
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../scope/">Scope and Goal</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Architecture</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../platform/">Automotive Platform</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../bodyelec/">Body Electronics</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../autonomous/">Autonomous Drive</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Components</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../components/">HW and Board Components</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../interfaces/">Interfaces and Sensors</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../software/">Software Repositories</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Usage Manual</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../start/">Start the GoKart</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../issues-todo/">Common Issues</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">For Developers</a>
    <ul class="current">
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">About</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../projects/">Thesis Projects</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../contact/">Contact Infotiv</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../terms/">Glossary of Terms</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../changelog/">ChangeLog</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Infotiv Autonomous Platform</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>Usage Manual &raquo;</li><li>For Developers</li>
    <li class="wy-breadcrumbs-aside">
        <a href="https://github.com/infotiv-research/gokart-documentation/edit/master/docs/dev.md"> Edit on infotiv-research/gokart-documentation</a>
    </li>
  </ul>
  <hr/>
</div>

          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h4 id="building-roscanbus">building RosCanBus<a class="headerlink" href="#building-roscanbus" title="Permanent link">&para;</a></h4>
<pre><code>root of the ROSCANBUS project is /home/olle/SSD/ROS_projects/RosCanBus/src/roscanbus for building the project

# To run the ruscanbus node:
kill -9 `pidof roscanbus_node` ; kill -9 `pidof roscore`  ; roscore &amp;

kill -9 `pidof roscanbus_node` ; source /opt/ros/melodic/setup.sh; cd /home/olle/SSD/ROS_projects/RosCanBus; /home/olle/SSD/ROS_projects/RosCanBus/src/roscanbus/build/devel/lib/roscanbus/roscanbus_node

</code></pre>
<h4 id="services">Services<a class="headerlink" href="#services" title="Permanent link">&para;</a></h4>
<p>To install services you need to use the <a href="https://gitlab.infotivlab.se/internal-development/autonomous-platform/gokart/gokart_setup">following repository</a>:</p>
<p><code>/etc/systemd/system/</code></p>
<pre><code class="language-txt">[Unit]
After=roscore.service
After=NetworkManager.service time-sync.target

[Service]
User=gokart1
WorkingDirectory=/home/gokart1/SSD/ROS_projects/RosCanBus
ExecStart=/bin/sh -c &quot;. /opt/ros/melodic/setup.sh; . /etc/ros/env.sh; /home/olle/SSD/ROS_projects/RosCanBus/src/roscanbus/build/devel/lib/roscanbus/roscanbus_node&quot;

[Install]
WantedBy=multi-user.target
</code></pre>
<pre><code class="language-bash">sudo systemctl enable roscanbus.service
sudo systemctl start  roscanbus.service
sudo systemctl status roscanbus.service
</code></pre>
<h4 id="gokart_controller-on-remote-client-machine">gokart_controller on remote client machine<a class="headerlink" href="#gokart_controller-on-remote-client-machine" title="Permanent link">&para;</a></h4>
<p><strong> Make sure roscanbus_node is running on GoKart </strong></p>
<pre><code class="language-bash">sudo apt-get install -y ros-sensor-msgs 
export ROS_MASTER_URI=http://dobby.local:11311
export ROS_IP=192.168.150.XXX   # ip address of the client machine

source /opt/ros/noetic/setup.bash  ############## VERY IMPORTANT
cd gokart_controller

python3 test.py 

</code></pre>
<h4 id="local-git-setup">Local git setup<a class="headerlink" href="#local-git-setup" title="Permanent link">&para;</a></h4>
<pre><code class="language-txt">Host gitlab.infotivlab.se
    Hostname 10.0.4.27
    IdentityFile ~/.ssh/id_rsa
    User git

</code></pre>
<h4 id="stm32-blue-pill-development-environment">STM32 Blue Pill Development environment<a class="headerlink" href="#stm32-blue-pill-development-environment" title="Permanent link">&para;</a></h4>
<pre><code>sudo apt-get install gcc-arm-none-eabi libnewlib-arm-none-eabi
arm-none-eabi-newlib # arch 

apt-get install openocd

Install Visual Studio Code
    a. sudo apt update
    b. sudo apt install snapd
    c. sudo snap install --classic code
Install apps
    sudo apt install git openocd gdb-multiarch gcc-arm-none-eabi libnewlib-arm-none-eabi
Link together multiarch and gdb
    a. Find path of &quot;gdb-multiarch&quot;, should be /usr/bin/gdb-multiarch
    b. sudo ln -s /usr/bin/gdb-multiarch /usr/bin/arm-none-eabi-gdb

Install build essential
    sudo apt-get install build-essential

Install st-link drivers
    a. sudo apt install git
    b. sudo apt install cmake
    c. sudo apt install gcc
    d. sudo apt install libusb-1.0
    e. git clone https://github.com/texane/stlink.git
    f. cd stlink
    g. make release
    h. cd build/Release
    i. sudo make install 
Connect ST-Link to STM32

    ST-Link STM32

    Pin 1       3v3
    Pin 7       SWIO
    Pin 9       SWCLK   
    Pin 20      GND




Install plugins
    a. Start VS code by typing &quot;code&quot; in terminal
    b. Ctrl+shift+x in VS code and install extensions C/C++ and Cortex-Debug
    c. If you are not working with the CEM, exchange the statements in the launch.json to correspond with the module you are working with (BMS, VCU etc)

Download repository
    a. git clone HTTPS_link
       git clone -b branch_name HTTPS_link (specific branch)
    b. cd into directory
    c. git submodule update –recursive  --init 

Create .elf 
    a. make gen_all
    b. make

First test
    a. Open the autonomous platform folder in VS code
    b. Make sure the STM32 is connected via USB and ST-link
    c. Start debugging (f5)
    d. This should build the project, upload it to the STM32, the ST-link should start blinking G/R and once uploaded the led on the STM should blink at 1Hz.


</code></pre>
<h4 id="st-link-dongle-to-the-blue-pill-connection">ST-LINK dongle to the Blue Pill connection<a class="headerlink" href="#st-link-dongle-to-the-blue-pill-connection" title="Permanent link">&para;</a></h4>
<h4 id="flash-vcpu">Flash VCPU<a class="headerlink" href="#flash-vcpu" title="Permanent link">&para;</a></h4>
<p><img alt="ST-LINK dongle" src="../assets/images/bluepill.jpeg" title="ST-LINK dongle" /></p>
<p>Create a file called openocd.cfg</p>
<pre><code class="language-txt">source [find interface/stlink-v2.cfg]
source [find target/stm32f1x.cfg]
</code></pre>
<p>and run <code>openocd -f openocd.cfg</code>:</p>
<pre><code class="language-console">Open On-Chip Debugger 0.10.0
Licensed under GNU GPL v2
For bug reports, read
    http://openocd.org/doc/doxygen/bugs.html
Info : auto-selecting first available session transport &quot;hla_swd&quot;. To override use 'transport select &lt;transport&gt;'.
Info : The selected transport took over low-level target control. The results might differ compared to plain JTAG/SWD
adapter speed: 1000 kHz
adapter_nsrst_delay: 100
none separate
Info : Unable to match requested speed 1000 kHz, using 950 kHz
Info : Unable to match requested speed 1000 kHz, using 950 kHz
Info : clock speed 950 kHz
Info : STLINK v2 JTAG v29 API v2 SWIM v7 VID 0x0483 PID 0x3748
Info : using stlink api v2
Info : Target voltage: 3.253369
Info : stm32f1x.cpu: hardware has 6 breakpoints, 4 watchpoints
</code></pre>
<p>Patch for gokart_vcu:</p>
<pre><code class="language-txt">update platform/arch/stm32/board/stm32f103board.mk

from 
    openocd -f board/stm32f103bp.cfg -c &quot;program $(BUILDDIR)/$(PROJECT_NAME).elf verify reset exit&quot;

to 
    openocd -f openocd.cfg -c &quot;program $(BUILDDIR)/$(PROJECT_NAME).elf verify reset exit&quot;
</code></pre>
<pre><code class="language-bash">make clean
make 
make gen_all
make upload_stlink # make upload for st_nucleo
</code></pre>
<p>Should results in:</p>
<pre><code class="language-bash">openocd -f openocd.cfg -c &quot;program build-stm32f103board/VCU.elf verify reset exit&quot;
Open On-Chip Debugger 0.10.0
Licensed under GNU GPL v2
For bug reports, read
    http://openocd.org/doc/doxygen/bugs.html
Info : auto-selecting first available session transport &quot;hla_swd&quot;. To override use 'transport select &lt;transport&gt;'.
Info : The selected transport took over low-level target control. The results might differ compared to plain JTAG/SWD
adapter speed: 1000 kHz
adapter_nsrst_delay: 100
none separate
Info : Unable to match requested speed 1000 kHz, using 950 kHz
Info : Unable to match requested speed 1000 kHz, using 950 kHz
Info : clock speed 950 kHz
Info : STLINK v2 JTAG v38 API v2 SWIM v7 VID 0x0483 PID 0x3748
Info : using stlink api v2
Info : Target voltage: 2.869531
Info : stm32f1x.cpu: hardware has 6 breakpoints, 4 watchpoints
target halted due to debug-request, current mode: Thread 
xPSR: 0x01000000 pc: 0x080048c4 msp: 0x20004ffc
** Programming Started **
auto erase enabled
Info : device id = 0x20036410
Info : flash size = 64kbytes
target halted due to breakpoint, current mode: Thread 
xPSR: 0x61000000 pc: 0x2000003a msp: 0x20004ffc
wrote 21504 bytes from file build-stm32f103board/VCU.elf in 1.232481s (17.039 KiB/s)
** Programming Finished **
** Verify Started **
target halted due to breakpoint, current mode: Thread 
xPSR: 0x61000000 pc: 0x2000002e msp: 0x20004ffc
target halted due to breakpoint, current mode: Thread 
xPSR: 0x61000000 pc: 0x2000002e msp: 0x20004ffc
verified 20656 bytes in 0.355877s (56.682 KiB/s)
** Verified OK **
** Resetting Target **
shutdown command invoked
make[1]: Leaving directory '/home/hamid/repositories/GOKART/gokart_vcu'
</code></pre>
<h4 id="debug-messages">Debug messages<a class="headerlink" href="#debug-messages" title="Permanent link">&para;</a></h4>
<p>To see the debug messages that are shown in the serial port with <code>logger.error()</code> function:</p>
<pre><code class="language-bash">sudo miniterm /dev/ttyUSB0 115200

[33;1m[WARNING]␛[0m No message from CAN. Restarting MCP2515
</code></pre>
<h4 id="ssh-keys">SSH keys<a class="headerlink" href="#ssh-keys" title="Permanent link">&para;</a></h4>
<p>There are already one ssh key added as an auithorized key to the gokart. copy the content of <code>/protectedDocuments/SSHKeys</code> <strong>(<a href="../contact/">Protected document</a>)</strong> to <code>~/.ssh/</code> directory. You will be able to connect to gokart without using password as below</p>
<pre><code class="language-bash">ssh gokart1@dobby.local
</code></pre>
<p>As an example you can shutdown the jetson board  like this:</p>
<pre><code class="language-bash">ssh gokart1@dobby.local &quot;shutdown -h now&quot;
</code></pre>
<h4 id="patches">Patches<a class="headerlink" href="#patches" title="Permanent link">&para;</a></h4>
<p>Patches for fixing the issue with remote control</p>
<pre><code>void RcView::updateSpeedPulse() 
{
    speedData_ = RC_SPEED_INPUT.get();
    if(speedData_ == 1 &amp;&amp; previousSpeedData_ != 1)
    {
        speedStartTime_ = get_system_time_ns();
    }
    else if(speedData_ == 0 &amp;&amp; previousSpeedData_ == 1)
    {
        speedEndTime_ = get_system_time_ns();
        if(speedEndTime_ - speedStartTime_ &gt; minSpeedPulse_ &amp;&amp; speedEndTime_ - speedStartTime_ &lt; maxSpeedPulse_) //Remove all misscalculations when timer overflows.
        {
            speedPulse_ = speedEndTime_ - speedStartTime_;
            float speedReq = linearConversion(speedPulse_, minSpeedPulse_, maxSpeedPulse_, 0, 1);

            if (speedReq &gt; 1) speedReq = 1;
            else if (speedReq &lt; 0) speedReq = 0;

            if(speedReq &gt; 0.55) //Acceleration signal
            {
                speedReq = (speedReq - 0.55) / (0.45);
                gokartModel_-&gt;setSpeedRequest(speedReq);
            }
            else if(speedReq &lt; 0.45) //brake signal
            {
                float brake_req = (speedReq / 0.45); 
                gokartModel_-&gt;setBrakeRequest(brake_req);
            }
            else
            {
                gokartModel_-&gt;setSpeedRequest(0);
                gokartModel_-&gt;setBrakeRequest(0);
            }

        }
    }
    previousSpeedData_ = speedData_;
}

</code></pre>
<p>The left steering is not implemented correctly or NOT at all</p>
<ol>
<li>gokart_controller / gokart_controller.py</li>
</ol>
<pre><code>     def set_power_enable(self):
        raise NotImplementedError

    def set_speed(self, speed):
        raise NotImplementedError

    def set_turn_rate(self, degrees):
        raise NotImplementedError
</code></pre>
<ol>
<li>last commit on gokart/Gokart_VCU</li>
</ol>
<pre><code>src/controllers/GokartController.cpp  

- #define minTurnPWM_ 0.069
- #define maxTurnPWM_ 0.051
+ #define minTurnPWM_ 0.074
+ #define maxTurnPWM_ 0.047

src/views/RcView.h 

-  static const int minTurnPulse_ = 1130000;
-  static const int maxTurnPulse_ = 1930000;
+  static const int minTurnPulse_ = 1050000;
+  static const int maxTurnPulse_ = 1850000;
</code></pre>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../issues-todo/" class="btn btn-neutral float-left" title="Common Issues"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../projects/" class="btn btn-neutral float-right" title="Thesis Projects">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../issues-todo/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../projects/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
